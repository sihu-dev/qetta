---
description: "확장 시스템 상태 확인 - DB, 커넥터, RLS, Rate Limiter, 성능 메트릭 종합 검사"
argument-hint: "[--full|--db|--connectors|--rls|--rate-limit|--perf]"
model: sonnet
allowed-tools: Read, Bash, WebFetch
---

# /health-extended 명령어

확장 시스템 헬스체크 - 모든 구성 요소의 상태를 종합적으로 확인합니다.

## 사용법

```bash
# 전체 상태 확인
/health-extended

# 개별 컴포넌트
/health-extended --db           # 데이터베이스만
/health-extended --connectors   # 커넥터만
/health-extended --rls          # RLS 정책만
/health-extended --rate-limit   # Rate Limiter만
/health-extended --perf         # 성능 메트릭만
```

---

## 검사 항목 (200점)

### A. 데이터베이스 (40점)

```yaml
검사 항목:
  연결 상태 (10점):
    - Supabase 연결 확인
    - 연결 풀 사용률 (< 80% = 정상)

  RLS 정책 (15점):
    - 모든 테이블 RLS 활성화
    - tenant_isolation 정책 존재
    - Service Role 제한적 사용

  쿼리 성능 (10점):
    - 평균 쿼리 시간 < 100ms
    - 느린 쿼리 (> 1s) 없음

  스토리지 (5점):
    - 디스크 사용률 < 80%
```

### B. 커넥터 상태 (50점)

```yaml
TED Connector (20점):
  - API 연결 상태
  - 마지막 수집 시간 (< 2시간)
  - 에러율 (< 5%)
  - 응답 시간 (< 5s)

SAM.gov Connector (20점):
  - API 연결 상태
  - 마지막 수집 시간 (< 2시간)
  - 에러율 (< 5%)
  - 응답 시간 (< 5s)

G2B Connector (10점):
  - Stub 상태 확인
  - 테스트 데이터 정상 여부
```

### C. API 상태 (40점)

```yaml
Health Endpoint (10점):
  - /api/v1/health 응답 확인
  - 응답 시간 < 200ms

주요 엔드포인트 (20점):
  - /api/v1/bids (GET)
  - /api/v1/matches (GET)
  - /api/v1/dashboard (GET)
  - 각 엔드포인트 응답 확인

Rate Limiter (10점):
  - Upstash Redis 연결
  - 현재 사용률
  - 차단된 요청 수
```

### D. 인프라 (40점)

```yaml
환경 변수 (15점):
  - 필수 변수 설정 여부
  - 시크릿 노출 확인

SSL/HTTPS (10점):
  - 인증서 유효성
  - 만료일 (> 30일)

보안 헤더 (10점):
  - CSP 설정
  - CORS 설정
  - X-Frame-Options

CDN/Edge (5점):
  - Vercel Edge 상태
  - 캐시 적중률
```

### E. 성능 메트릭 (30점)

```yaml
Core Web Vitals (15점):
  - LCP < 2.5s
  - FID < 100ms
  - CLS < 0.1

서버 성능 (15점):
  - 평균 응답 시간
  - p95 응답 시간
  - 처리량 (req/s)
```

---

## 실행 절차

```yaml
Step 1: 환경 변수 확인
  - NEXT_PUBLIC_SUPABASE_URL
  - SUPABASE_SERVICE_ROLE_KEY
  - TED_API_KEY
  - SAM_GOV_API_KEY
  - UPSTASH_REDIS_*

Step 2: 데이터베이스 연결
  - curl /api/v1/health
  - 쿼리 실행 테스트

Step 3: 커넥터 상태
  - TED API ping
  - SAM API ping
  - 마지막 수집 시간 확인

Step 4: RLS 정책 검증
  - 테이블별 RLS 상태
  - 정책 개수 확인

Step 5: Rate Limiter
  - Redis 연결 확인
  - 현재 토큰 버킷 상태

Step 6: 성능 측정
  - Lighthouse 점수 (선택)
  - 응답 시간 측정
```

---

## 출력 형식

```
╔══════════════════════════════════════════════════════════════╗
║            BIDFLOW 확장 헬스체크 보고서                        ║
╠══════════════════════════════════════════════════════════════╣
║  시간: 2025-01-15 14:30:00 KST                                ║
║  환경: Production                                             ║
║  버전: 2.0.0-beta                                             ║
╚══════════════════════════════════════════════════════════════╝

┌─ A. 데이터베이스 ─────────────────────── 38/40점 ────────────┐
│                                                               │
│  Supabase 연결       ✅ UP        지연: 15ms                 │
│  연결 풀             ✅ 12/100    사용률: 12%                │
│  RLS 정책            ✅ 6/6       모든 테이블 활성화          │
│  쿼리 성능           ✅ 45ms      느린 쿼리: 0건             │
│  스토리지            ⚠️ 72%       경고 임계값 근접            │
│                                                               │
└───────────────────────────────────────────────────────────────┘

┌─ B. 커넥터 상태 ──────────────────────── 48/50점 ────────────┐
│                                                               │
│  TED Connector                                                │
│    ├─ 상태             ✅ UP                                  │
│    ├─ 마지막 수집      45분 전                                │
│    ├─ 에러율           0.5%                                   │
│    └─ 응답 시간        1.2s                                   │
│                                                               │
│  SAM.gov Connector                                            │
│    ├─ 상태             ✅ UP                                  │
│    ├─ 마지막 수집      1시간 전                               │
│    ├─ 에러율           0.2%                                   │
│    └─ 응답 시간        0.8s                                   │
│                                                               │
│  G2B Connector                                                │
│    ├─ 상태             ⚠️ STUB                               │
│    └─ 모드             테스트 데이터                          │
│                                                               │
└───────────────────────────────────────────────────────────────┘

┌─ C. API 상태 ─────────────────────────── 40/40점 ────────────┐
│                                                               │
│  /api/v1/health        ✅ 200      45ms                       │
│  /api/v1/bids          ✅ 200      120ms                      │
│  /api/v1/matches       ✅ 200      89ms                       │
│  /api/v1/dashboard     ✅ 200      156ms                      │
│                                                               │
│  Rate Limiter                                                 │
│    ├─ Redis 연결       ✅ UP                                  │
│    ├─ 현재 사용률      15%                                    │
│    └─ 차단 요청        0건 (지난 1시간)                       │
│                                                               │
└───────────────────────────────────────────────────────────────┘

┌─ D. 인프라 ───────────────────────────── 38/40점 ────────────┐
│                                                               │
│  환경 변수            ✅ 8/8      모두 설정됨                 │
│  SSL 인증서           ✅ 유효     만료: 89일 남음             │
│  보안 헤더            ✅ 5/5      CSP, CORS, X-Frame          │
│  Vercel Edge          ⚠️ 85%     캐시 적중률                  │
│                                                               │
└───────────────────────────────────────────────────────────────┘

┌─ E. 성능 메트릭 ──────────────────────── 28/30점 ────────────┐
│                                                               │
│  Core Web Vitals                                              │
│    ├─ LCP              ✅ 1.8s    (< 2.5s)                    │
│    ├─ FID              ✅ 45ms    (< 100ms)                   │
│    └─ CLS              ⚠️ 0.12   (< 0.1 권장)                 │
│                                                               │
│  서버 성능                                                    │
│    ├─ 평균 응답        89ms                                   │
│    ├─ p95 응답         234ms                                  │
│    └─ 처리량           45 req/s                               │
│                                                               │
└───────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════
                    총점: 192/200점 (96%)
═══════════════════════════════════════════════════════════════

등급: A+ (우수)
판정: ✅ HEALTHY

┌─ 권장 조치 ───────────────────────────────────────────────────┐
│                                                               │
│  [MEDIUM] 스토리지 사용률 72%                                 │
│    → 로그 정리 또는 용량 확장 권장                            │
│                                                               │
│  [LOW] CLS 0.12 (권장: < 0.1)                                 │
│    → 이미지 width/height 명시, 폰트 프리로드                  │
│                                                               │
│  [INFO] G2B Connector는 현재 Stub 모드입니다                  │
│    → 정식 API 확보 후 실제 연동 예정                          │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

---

## 자동 실행

```yaml
스케줄:
  - 매 5분: 기본 헬스체크 (/health)
  - 매 1시간: 확장 헬스체크 (/health-extended)
  - 매일 00:00: 전체 리포트 생성

알림 트리거:
  - 점수 < 160점: WARNING
  - 점수 < 120점: ERROR
  - 컴포넌트 DOWN: CRITICAL
```

---

## 관련 파일

```
src/app/api/v1/
├── health/route.ts              # 기본 헬스체크
└── admin/health-extended/route.ts  # 확장 헬스체크

src/lib/monitoring/
├── health-checker.ts            # 헬스체크 로직
├── connector-health.ts          # 커넥터 상태 확인
├── rls-checker.ts               # RLS 정책 검증
└── performance-metrics.ts       # 성능 메트릭 수집
```
